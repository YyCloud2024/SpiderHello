{% extends "pc/template.html" %}

{% block title %}
éŸ³ä¹é¦–é¡µ - çˆ¬è™«éŸ³ä¹å¹³å°
{% endblock %}


{% block css %}
<style>
/* ä¸»é¢˜è‰²å½©é…ç½® - èåˆç´«è‰²ç¥ç§˜è´¨æ„Ÿã€å¤©è“è‰²æ¸…é€æ„Ÿä¸æŠ¹èŒ¶ç»¿ */
:root {
  --primary-purple: #6366f1;
  --secondary-purple: #8b5cf6;
  --light-purple: #c4b5fd;
  --sky-blue: #0ea5e9;
  --light-blue: #7dd3fc;
  --matcha-green: #10b981;
  --light-green: #6ee7b7;
  --dark-bg: #1e1b4b;
  --card-bg: rgba(99, 102, 241, 0.1);
  --glass-bg: rgba(255, 255, 255, 0.1);
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --shadow-purple: 0 10px 25px rgba(99, 102, 241, 0.3);
  --shadow-blue: 0 8px 20px rgba(14, 165, 233, 0.2);
  --gradient-primary: linear-gradient(135deg, var(--primary-purple), var(--sky-blue));
  --gradient-secondary: linear-gradient(135deg, var(--matcha-green), var(--light-blue));
}

/* éŸ³ä¹é¡µé¢ä¸»å®¹å™¨ */
.music-container {
  background: linear-gradient(135deg, #f0f9ff 0%, #ede9fe 50%, #ecfdf5 100%);
  min-height: 100vh;
  padding: 20px;
}

/* å¤´éƒ¨åŒºåŸŸ */
.music-header {
  background: var(--gradient-primary);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-purple);
  color: white;
  position: relative;
  overflow: hidden;
}

.music-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="spider" patternUnits="userSpaceOnUse" width="20" height="20"><path d="M10,2 L18,10 L10,18 L2,10 Z" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23spider)"/></svg>') repeat;
  opacity: 0.3;
}

.music-header .content {
  position: relative;
  z-index: 1;
}

.music-title {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.music-subtitle {
  font-size: 16px;
  opacity: 0.9;
}

/* çº¿è·¯åˆ‡æ¢åŒºåŸŸ */
.route-switcher {
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-blue);
}

.route-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 20px;
}

.route-tab {
  padding: 10px 20px;
  border: 2px solid var(--primary-purple);
  border-radius: 25px;
  background: transparent;
  color: var(--primary-purple);
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  min-width: 120px;
  text-align: center;
}

.route-tab:hover {
  background: var(--primary-purple);
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-purple);
}

.route-tab.active {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-purple);
}

/* æœç´¢åŒºåŸŸ */
.search-section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 1px solid var(--light-purple);
}

.search-form {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.search-input {
  flex: 1;
  min-width: 200px;
  padding: 12px 16px;
  border: 2px solid var(--light-purple);
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
}

.search-input:focus {
  outline: none;
  border-color: var(--primary-purple);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-btn {
  padding: 12px 24px;
  background: var(--gradient-secondary);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  min-width: 100px;
}

.search-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
}

/* éŸ³ä¹åˆ—è¡¨åŒºåŸŸ */
.music-list-section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 1px solid var(--light-blue);
}

.section-title {
  font-size: 20px;
  font-weight: bold;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--light-purple);
}

.music-list {
  display: grid;
  gap: 16px;
}

.music-item {
  display: flex;
  align-items: center;
  padding: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  transition: all 0.3s ease;
  cursor: pointer;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(14, 165, 233, 0.02));
}

.music-item:hover {
  border-color: var(--primary-purple);
  box-shadow: var(--shadow-purple);
  transform: translateY(-2px);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(14, 165, 233, 0.1));
}

.music-index {
  width: 40px;
  height: 40px;
  background: var(--gradient-primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-right: 16px;
}

.music-info {
  flex: 1;
}

.music-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.music-id {
  font-size: 12px;
  color: var(--text-secondary);
  font-family: monospace;
}

.music-actions {
  display: flex;
  gap: 8px;
}

.play-btn {
  width: 40px;
  height: 40px;
  background: var(--gradient-secondary);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.play-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

/* åŠ è½½çŠ¶æ€ */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.loading-spinner {
  display: inline-block;
  width: 32px;
  height: 32px;
  border: 3px solid var(--light-purple);
  border-top: 3px solid var(--primary-purple);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 48px;
  color: var(--light-purple);
  margin-bottom: 16px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1199px) {
  .music-container {
    padding: 16px;
  }
  
  .music-header {
    padding: 20px;
  }
  
  .music-title {
    font-size: 24px;
  }
}

@media (max-width: 767px) {
  .music-container {
    padding: 12px;
  }
  
  .music-header {
    padding: 16px;
  }
  
  .music-title {
    font-size: 20px;
  }
  
  .route-tabs {
    justify-content: center;
  }
  
  .route-tab {
    min-width: 100px;
    font-size: 14px;
    padding: 8px 16px;
  }
  
  .search-form {
    flex-direction: column;
  }
  
  .search-input {
    width: 100%;
  }
  
  .search-btn {
    width: 100%;
  }
  
  .music-item {
    flex-wrap: wrap;
  }
  
  .music-actions {
    width: 100%;
    justify-content: flex-end;
    margin-top: 8px;
  }
}

/* è§¦æ§ä¼˜åŒ– */
@media (max-width: 767px) {
  .music-item,
  .route-tab,
  .search-btn,
  .play-btn {
    min-height: 44px;
    min-width: 44px;
  }
}

/* é«˜åˆ†è¾¨ç‡é€‚é… */
@media (min-width: 1400px) {
  .music-container {
    max-width: 1200px;
    margin: 0 auto;
  }
}

/* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
.music-player {
  position: fixed;
  bottom: 20px;
  left: 20px;
  right: 20px;
  background: linear-gradient(135deg, rgba(30, 27, 75, 0.95), rgba(99, 102, 241, 0.85));
  backdrop-filter: blur(15px);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
  z-index: 1000;
  transform: translateY(100%);
  transition: transform 0.4s ease;
  display: none; /* é»˜è®¤éšè— */
}

.music-player.show {
  transform: translateY(0);
  display: block; /* æ˜¾ç¤ºæ—¶æ‰æ˜¾ç¤º */
}

.player-content {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.player-cover {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid var(--primary-purple);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.player-info {
  flex: 1;
  min-width: 200px;
}

.player-title {
  font-size: 16px;
  font-weight: 600;
  color: white;
  margin-bottom: 4px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

.player-artist {
  font-size: 14px;
  color: rgba(255,255,255,0.9);
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.player-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.control-btn {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
  color: white;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
}

.control-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6), inset 0 1px 0 rgba(255,255,255,0.3);
  background: linear-gradient(135deg, var(--secondary-purple), var(--primary-purple));
}

.control-btn.play-pause {
  width: 52px;
  height: 52px;
  background: linear-gradient(135deg, var(--matcha-green), var(--sky-blue));
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
}

.control-btn.play-pause:hover {
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6), inset 0 1px 0 rgba(255,255,255,0.3);
  background: linear-gradient(135deg, var(--sky-blue), var(--matcha-green));
}

/* æ’­æ”¾è¿›åº¦æ¡æ ·å¼ */
.progress-section {
  width: 100%;
  margin-bottom: 12px;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.time-info {
  display: flex;
  gap: 8px;
  color: white;
  font-size: 12px;
  font-family: monospace;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  background: rgba(0,0,0,0.3);
  padding: 4px 8px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.1);
}

.progress-container {
  position: relative;
  width: 100%;
  height: 8px;
  background: rgba(0,0,0,0.4);
  border-radius: 4px;
  cursor: pointer;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--matcha-green), var(--sky-blue));
  border-radius: 4px;
  width: 0%;
  transition: width 0.1s ease;
  position: relative;
  box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
}

.progress-bar::after {
  content: '';
  position: absolute;
  right: -6px;
  top: 50%;
  transform: translateY(-50%);
  width: 12px;
  height: 12px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5), 0 0 0 2px var(--matcha-green);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.progress-container:hover .progress-bar::after {
  opacity: 1;
}

/* æ’­æ”¾æ¨¡å¼æ§åˆ¶æ ·å¼ */
.playmode-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.playmode-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.playmode-btn {
  width: 36px;
  height: 36px;
  background: rgba(0,0,0,0.4);
  color: rgba(255,255,255,0.8);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 14px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.1), 0 2px 4px rgba(0,0,0,0.3);
}

.playmode-btn:hover {
  background: rgba(99, 102, 241, 0.6);
  color: white;
  border-color: var(--primary-purple);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 4px 8px rgba(99, 102, 241, 0.4);
  transform: translateY(-1px);
}

.playmode-btn.active {
  background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
  color: white;
  border-color: var(--primary-purple);
  box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3), inset 0 1px 0 rgba(255,255,255,0.2), 0 4px 8px rgba(99, 102, 241, 0.4);
}

.playmode-text {
  color: white;
  font-size: 12px;
  margin-left: 8px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  background: rgba(0,0,0,0.3);
  padding: 4px 8px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.1);
}

.volume-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.volume-btn {
  width: 32px;
  height: 32px;
  background: rgba(0,0,0,0.4);
  color: white;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.1), 0 2px 4px rgba(0,0,0,0.3);
}

.volume-btn:hover {
  background: rgba(14, 165, 233, 0.6);
  border-color: var(--sky-blue);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 4px 8px rgba(14, 165, 233, 0.4);
  transform: translateY(-1px);
}

.volume-slider {
  width: 80px;
  height: 6px;
  background: rgba(0,0,0,0.4);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
}

.volume-progress {
  height: 100%;
  background: linear-gradient(90deg, var(--sky-blue), var(--primary-purple));
  border-radius: 3px;
  width: 70%;
  transition: width 0.1s ease;
  box-shadow: 0 0 6px rgba(14, 165, 233, 0.6);
}

/* ç§»åŠ¨ç«¯æ’­æ”¾å™¨æ ·å¼è°ƒæ•´ */
@media (max-width: 767px) {
  .music-player {
    left: 12px;
    right: 12px;
    bottom: 12px;
    padding: 16px;
  }
  
  .player-content {
    flex-direction: column;
    text-align: center;
    margin-bottom: 12px;
  }
  
  .player-info {
    min-width: auto;
    width: 100%;
  }
  
  .playmode-section {
    flex-direction: column;
    gap: 12px;
  }
  
  .volume-controls {
    order: -1;
  }
  
  .volume-slider {
    width: 120px;
  }
}
</style>
{% endblock %}


{% block content %}
<div class="music-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <div class="music-header">
    <div class="content">
      <h1 class="music-title">
        <i class="layui-icon layui-icon-headset"></i>
        è››ç½‘éŸ³ä¹
      </h1>
      <p class="music-subtitle">æ¢ç´¢éŸ³ä¹çš„ç¥ç§˜ä¸–ç•Œï¼Œæ„Ÿå—å¤©ç±ä¹‹éŸ³</p>
    </div>
  </div>

  <!-- çº¿è·¯åˆ‡æ¢åŒºåŸŸ -->
  <div class="route-switcher">
    <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">
      <i class="layui-icon layui-icon-website"></i>
      éŸ³ä¹çº¿è·¯é€‰æ‹©
    </h3>
    <div class="route-tabs">
      <div class="route-tab active" data-route="www_2t58_com">
        <i class="layui-icon layui-icon-music"></i>
        2T58éŸ³ä¹
      </div>
      <div class="route-tab" data-route="coming_soon_1">
        <i class="layui-icon layui-icon-play"></i>
        éŸ³ä¹æº2
        <span style="font-size: 10px; opacity: 0.7;">(å³å°†ä¸Šçº¿)</span>
      </div>
      <div class="route-tab" data-route="coming_soon_2">
        <i class="iconfont icon-24gf-volumeLow"></i>
        éŸ³ä¹æº3
        <span style="font-size: 10px; opacity: 0.7;">(å³å°†ä¸Šçº¿)</span>
      </div>
    </div>
    <div class="route-info">
      <p style="color: var(--text-secondary); margin: 0; font-size: 14px;">
        <i class="layui-icon layui-icon-tips"></i>
        å½“å‰é€‰æ‹©: <span id="current-route-name">2T58éŸ³ä¹</span> - æä¾›æµ·é‡é«˜å“è´¨éŸ³ä¹èµ„æº
      </p>
    </div>
  </div>

  <!-- æœç´¢åŒºåŸŸ -->
  <div class="search-section">
    <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">
      <i class="layui-icon layui-icon-search"></i>
      éŸ³ä¹æœç´¢
    </h3>
    <form class="search-form" id="music-search-form">
      <input 
        type="text" 
        class="search-input" 
        id="music-search-input"
        placeholder="è¯·è¾“å…¥æ­Œæ›²åç§°ã€æ­Œæ‰‹æˆ–ä¸“è¾‘..." 
        maxlength="100"
        required
      >
      <button type="submit" class="search-btn" id="search-btn">
        <i class="layui-icon layui-icon-search"></i>
        æœç´¢éŸ³ä¹
      </button>
    </form>
  </div>

  <!-- éŸ³ä¹åˆ—è¡¨åŒºåŸŸ -->
  <div class="music-list-section">
    <h3 class="section-title">
      <i class="layui-icon layui-icon-list"></i>
      éŸ³ä¹åˆ—è¡¨
    </h3>
    <div id="music-list-container">
      <div class="empty-state">
        <div class="empty-icon">
          <i class="layui-icon layui-icon-search"></i>
        </div>
        <p style="font-size: 16px; margin: 0;">è¯·æœç´¢æ‚¨å–œæ¬¢çš„éŸ³ä¹</p>
        <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.7;">è¾“å…¥æ­Œæ›²åç§°ã€æ­Œæ‰‹æˆ–ä¸“è¾‘åç§°å¼€å§‹æ¢ç´¢</p>
      </div>
    </div>
  </div>
</div>

<!-- éŸ³ä¹æ’­æ”¾å™¨ -->
<div class="music-player" id="music-player">
  <!-- ä¸»æ’­æ”¾å™¨åŒºåŸŸ -->
  <div class="player-content">
    <img src="" alt="ä¸“è¾‘å°é¢" class="player-cover" id="player-cover">
    <div class="player-info">
      <div class="player-title" id="player-title">æœªæ’­æ”¾éŸ³ä¹</div>
      <div class="player-artist" id="player-artist">é€‰æ‹©éŸ³ä¹å¼€å§‹æ’­æ”¾</div>
    </div>
    <div class="player-controls">
      <button class="control-btn" id="prev-btn" title="ä¸Šä¸€é¦–">
        <i class="layui-icon layui-icon-prev"></i>
      </button>
      <button class="control-btn play-pause" id="play-pause-btn" title="æ’­æ”¾/æš‚åœ">
        <i class="layui-icon layui-icon-play"></i>
      </button>
      <button class="control-btn" id="next-btn" title="ä¸‹ä¸€é¦–">
        <i class="layui-icon layui-icon-next"></i>
      </button>
      <button class="control-btn" id="close-player-btn" title="å…³é—­æ’­æ”¾å™¨">
        <i class="layui-icon layui-icon-close"></i>
      </button>
    </div>
  </div>
  
  <!-- æ’­æ”¾è¿›åº¦åŒºåŸŸ -->
  <div class="progress-section">
    <div class="progress-info">
      <div class="time-info">
        <span id="current-time">00:00</span>
        <span>/</span>
        <span id="total-time">00:00</span>
      </div>
    </div>
    <div class="progress-container" id="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>
  
  <!-- æ’­æ”¾æ¨¡å¼å’ŒéŸ³é‡æ§åˆ¶ -->
  <div class="playmode-section">
    <div class="playmode-controls">
      <button class="playmode-btn active" id="sequence-btn" data-mode="sequence" title="é¡ºåºæ’­æ”¾">
        <i class="layui-icon layui-icon-menu-fill"></i>
      </button>
      <button class="playmode-btn" id="random-btn" data-mode="random" title="éšæœºæ’­æ”¾">
        <i class="iconfont icon-suijibofang"></i>
      </button>
      <button class="playmode-btn" id="repeat-btn" data-mode="repeat" title="å•æ›²å¾ªç¯">
        <i class="layui-icon layui-icon-refresh-3"></i>
      </button>
      <span class="playmode-text" id="playmode-text">é¡ºåºæ’­æ”¾</span>
    </div>
    
    <div class="volume-controls">
      <button class="volume-btn" id="volume-btn" title="éŸ³é‡">
        <i class="iconfont icon-24gf-volumeLow"></i>
      </button>
      <div class="volume-slider" id="volume-slider">
        <div class="volume-progress" id="volume-progress"></div>
      </div>
    </div>
  </div>
  
  <audio id="audio-player" preload="none"></audio>
</div>
{% endblock %}

{% block footer %}
<!-- åº•éƒ¨ä¿¡æ¯ -->
<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
  <p>ğŸ•·ï¸ è››ç½‘éŸ³ä¹å¹³å° - æ¢ç´¢æ— é™éŸ³ä¹å¯èƒ½</p>
</div>
{% endblock %}

{% block js %}
<script>
layui.use(['layer'], function(){
  const layer = layui.layer;
  
  // å…¨å±€å˜é‡
  let currentRoute = 'www_2t58_com';
  let musicList = [];
  let currentPlayingIndex = -1;
  let isPlaying = false;
  let audioPlayer = null;
  let playMode = 'sequence'; // sequence: é¡ºåºæ’­æ”¾, random: éšæœºæ’­æ”¾, repeat: å•æ›²å¾ªç¯
  let volume = 0.7; // é»˜è®¤éŸ³é‡ 70%
  let isMuted = false;
  let isDragging = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½è¿›åº¦æ¡
  
  // DOMå…ƒç´ 
  const searchForm = document.getElementById('music-search-form');
  const searchInput = document.getElementById('music-search-input');
  const searchBtn = document.getElementById('search-btn');
  const musicListContainer = document.getElementById('music-list-container');
  const musicPlayer = document.getElementById('music-player');
  const audioElement = document.getElementById('audio-player');
  const playerCover = document.getElementById('player-cover');
  const playerTitle = document.getElementById('player-title');
  const playerArtist = document.getElementById('player-artist');
  const playPauseBtn = document.getElementById('play-pause-btn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const closePlayerBtn = document.getElementById('close-player-btn');
  const routeTabs = document.querySelectorAll('.route-tab');
  const currentRouteName = document.getElementById('current-route-name');
  
  // è¿›åº¦æ¡ç›¸å…³å…ƒç´ 
  const progressContainer = document.getElementById('progress-container');
  const progressBar = document.getElementById('progress-bar');
  const currentTimeSpan = document.getElementById('current-time');
  const totalTimeSpan = document.getElementById('total-time');
  
  // æ’­æ”¾æ¨¡å¼ç›¸å…³å…ƒç´ 
  const sequenceBtn = document.getElementById('sequence-btn');
  const randomBtn = document.getElementById('random-btn');
  const repeatBtn = document.getElementById('repeat-btn');
  const playmodeText = document.getElementById('playmode-text');
  
  // éŸ³é‡æ§åˆ¶ç›¸å…³å…ƒç´ 
  const volumeBtn = document.getElementById('volume-btn');
  const volumeSlider = document.getElementById('volume-slider');
  const volumeProgress = document.getElementById('volume-progress');
  
  // éŸ³é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–
  audioPlayer = audioElement;
  
  // åˆå§‹åŒ–
  init();
  
  function init() {
    bindEvents();
    setupAudioEvents();
    initializePlayer();
  }
  
  // åˆå§‹åŒ–æ’­æ”¾å™¨
  function initializePlayer() {
    // è®¾ç½®åˆå§‹éŸ³é‡
    audioPlayer.volume = volume;
    updateVolumeDisplay();
    
    // è®¾ç½®åˆå§‹æ’­æ”¾æ¨¡å¼
    updatePlayModeDisplay();
  }
  
  // ç»‘å®šäº‹ä»¶
  function bindEvents() {
    // æœç´¢è¡¨å•æäº¤
    searchForm.addEventListener('submit', handleSearch);
    
    // çº¿è·¯åˆ‡æ¢
    routeTabs.forEach(tab => {
      tab.addEventListener('click', handleRouteChange);
    });
    
    // æ’­æ”¾å™¨æ§åˆ¶
    playPauseBtn.addEventListener('click', togglePlayPause);
    prevBtn.addEventListener('click', playPrevious);
    nextBtn.addEventListener('click', playNext);
    closePlayerBtn.addEventListener('click', closePlayer);
    
    // è¿›åº¦æ¡äº‹ä»¶
    progressContainer.addEventListener('click', seekTo);
    progressContainer.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', dragProgress);
    document.addEventListener('mouseup', endDrag);
    
    // æ’­æ”¾æ¨¡å¼åˆ‡æ¢
    sequenceBtn.addEventListener('click', () => setPlayMode('sequence'));
    randomBtn.addEventListener('click', () => setPlayMode('random'));
    repeatBtn.addEventListener('click', () => setPlayMode('repeat'));
    
    // éŸ³é‡æ§åˆ¶
    volumeBtn.addEventListener('click', toggleMute);
    volumeSlider.addEventListener('click', setVolume);
    
    // å›è½¦æœç´¢
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleSearch(e);
      }
    });
  }
  
  // è®¾ç½®éŸ³é¢‘äº‹ä»¶
  function setupAudioEvents() {
    audioPlayer.addEventListener('loadstart', function() {
      console.log('å¼€å§‹åŠ è½½éŸ³é¢‘');
    });
    
    audioPlayer.addEventListener('loadedmetadata', function() {
      updateTotalTime();
    });
    
    audioPlayer.addEventListener('canplay', function() {
      console.log('éŸ³é¢‘å¯ä»¥æ’­æ”¾');
    });
    
    audioPlayer.addEventListener('play', function() {
      isPlaying = true;
      updatePlayPauseButton();
    });
    
    audioPlayer.addEventListener('pause', function() {
      isPlaying = false;
      updatePlayPauseButton();
    });
    
    audioPlayer.addEventListener('timeupdate', function() {
      if (!isDragging) {
        updateProgress();
      }
    });
    
    audioPlayer.addEventListener('ended', function() {
      handleAudioEnded();
    });
    
    audioPlayer.addEventListener('error', function(e) {
      console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
      layer.msg('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–éŸ³ä¹', {icon: 2});
      isPlaying = false;
      updatePlayPauseButton();
    });
  }
  
  // å¤„ç†æœç´¢
  async function handleSearch(e) {
    e.preventDefault();
    
    const keyword = searchInput.value.trim();
    if (!keyword) {
      layer.msg('è¯·è¾“å…¥æœç´¢å…³é”®è¯', {icon: 0});
      return;
    }
    
    if (currentRoute !== 'www_2t58_com') {
      layer.msg('è¯¥éŸ³ä¹æºæš‚æœªå¼€æ”¾ï¼Œæ•¬è¯·æœŸå¾…', {icon: 0});
      return;
    }
    
    setSearchLoading(true);
    
    try {
      const response = await axios({
        method: 'POST',
        url: '/api/music/www_2t58_com/search/',
        data: new URLSearchParams({
          music_name: keyword
        }),
        headers: {
          'Authorization': 'Bearer b9391759-3d18-4edd-8768-b59abc100ba3',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        timeout: 30000
      });
      
      if (response.data.code === 0) {
        musicList = response.data.data || [];
        renderMusicList();
        layer.msg(`æ‰¾åˆ° ${musicList.length} é¦–ç›¸å…³éŸ³ä¹`, {icon: 1});
      } else {
        throw new Error(response.data.message || 'æœç´¢å¤±è´¥');
      }
    } catch (error) {
      console.error('æœç´¢é”™è¯¯:', error);
      let errorMsg = 'æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      if (error.response) {
        errorMsg = `æœç´¢å¤±è´¥: ${error.response.status}`;
      } else if (error.code === 'ECONNABORTED') {
        errorMsg = 'æœç´¢è¶…æ—¶ï¼Œè¯·é‡è¯•';
      }
      layer.msg(errorMsg, {icon: 2});
      renderEmptyState('æœç´¢å¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
    } finally {
      setSearchLoading(false);
    }
  }
  
  // è®¾ç½®æœç´¢åŠ è½½çŠ¶æ€
  function setSearchLoading(loading) {
    if (loading) {
      searchBtn.disabled = true;
      searchBtn.innerHTML = '<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> æœç´¢ä¸­...';
      renderLoadingState();
    } else {
      searchBtn.disabled = false;
      searchBtn.innerHTML = '<i class="layui-icon layui-icon-search"></i> æœç´¢éŸ³ä¹';
    }
  }
  
  // æ¸²æŸ“éŸ³ä¹åˆ—è¡¨
  function renderMusicList() {
    if (!musicList || musicList.length === 0) {
      renderEmptyState('æš‚æ— æœç´¢ç»“æœ', 'è¯·å°è¯•å…¶ä»–å…³é”®è¯');
      return;
    }
    
    const listHtml = musicList.map((music, index) => `
      <div class="music-item" data-index="${index}">
        <div class="music-index">${index + 1}</div>
        <div class="music-info">
          <div class="music-name" title="${escapeHtml(music.name)}">${escapeHtml(music.name)}</div>
          <div class="music-id">ID: ${escapeHtml(music.music_id)}</div>
        </div>
        <div class="music-actions">
          <button class="play-btn" onclick="playMusic(${index})" title="æ’­æ”¾éŸ³ä¹">
            <i class="layui-icon layui-icon-play"></i>
          </button>
        </div>
      </div>
    `).join('');
    
    musicListContainer.innerHTML = `<div class="music-list">${listHtml}</div>`;
  }
  
  // æ¸²æŸ“åŠ è½½çŠ¶æ€
  function renderLoadingState() {
    musicListContainer.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨æœç´¢éŸ³ä¹...</p>
      </div>
    `;
  }
  
  // æ¸²æŸ“ç©ºçŠ¶æ€
  function renderEmptyState(title, subtitle) {
    musicListContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <i class="layui-icon layui-icon-face-cry"></i>
        </div>
        <p style="font-size: 16px; margin: 0;">${title}</p>
        <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.7;">${subtitle}</p>
      </div>
    `;
  }
  
  // æ’­æ”¾éŸ³ä¹
  window.playMusic = async function(index) {
    if (!musicList[index]) {
      layer.msg('éŸ³ä¹ä¸å­˜åœ¨', {icon: 2});
      return;
    }
    
    const music = musicList[index];
    currentPlayingIndex = index;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loadingIndex = layer.load(1, {
      content: 'æ­£åœ¨è·å–éŸ³ä¹æ•°æ®...',
      success: function(layero){
        layero.find('.layui-layer-content').css({color: '#333'});
      }
    });
    
    try {
      // è·å–éŸ³ä¹æ•°æ®
      const response = await axios({
        method: 'POST',
        url: '/api/music/www_2t58_com/music/data/',
        data: new URLSearchParams({
          music_id: music.music_id
        }),
        headers: {
          'Authorization': 'Bearer b9391759-3d18-4edd-8768-b59abc100ba3',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        timeout: 30000
      });
      
      if (response.data.code === 0) {
        const musicData = response.data.data;
        
        // æ›´æ–°æ’­æ”¾å™¨ä¿¡æ¯
        playerTitle.textContent = musicData.name || music.name;
        playerArtist.textContent = musicData.artistName || 'æœªçŸ¥è‰ºäºº';
        
        // è®¾ç½®å°é¢å›¾
        if (musicData.music_cover) {
          playerCover.src = musicData.music_cover;
          playerCover.style.display = 'block';
        } else {
          playerCover.style.display = 'none';
        }
        
        // è®¾ç½®éŸ³é¢‘æº
        audioPlayer.src = musicData.music_url;
        
        // é‡ç½®è¿›åº¦æ¡
        progressBar.style.width = '0%';
        currentTimeSpan.textContent = '00:00';
        totalTimeSpan.textContent = '00:00';
        
        // æ˜¾ç¤ºæ’­æ”¾å™¨
        showPlayer();
        
        // å¼€å§‹æ’­æ”¾
        try {
          await audioPlayer.play();
          layer.msg(`å¼€å§‹æ’­æ”¾: ${musicData.name}`, {icon: 1});
        } catch (playError) {
          console.error('æ’­æ”¾é”™è¯¯:', playError);
          layer.msg('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®', {icon: 0});
        }
      } else {
        throw new Error(response.data.message || 'è·å–éŸ³ä¹æ•°æ®å¤±è´¥');
      }
    } catch (error) {
      console.error('è·å–éŸ³ä¹æ•°æ®é”™è¯¯:', error);
      let errorMsg = 'è·å–éŸ³ä¹æ•°æ®å¤±è´¥';
      if (error.response) {
        errorMsg = `è·å–å¤±è´¥: ${error.response.status}`;
      } else if (error.code === 'ECONNABORTED') {
        errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
      }
      layer.msg(errorMsg, {icon: 2});
    } finally {
      layer.close(loadingIndex);
    }
  }
  
  // å¤„ç†çº¿è·¯åˆ‡æ¢
  function handleRouteChange(e) {
    const route = e.currentTarget.dataset.route;
    
    if (route === currentRoute) return;
    
    if (route.startsWith('coming_soon')) {
      layer.msg('è¯¥çº¿è·¯å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…', {icon: 0});
      return;
    }
    
    // æ›´æ–°å½“å‰çº¿è·¯
    currentRoute = route;
    
    // æ›´æ–°UI
    routeTabs.forEach(tab => {
      tab.classList.toggle('active', tab.dataset.route === route);
    });
    
    // æ›´æ–°çº¿è·¯åç§°
    const routeNames = {
      'www_2t58_com': '2T58éŸ³ä¹'
    };
    currentRouteName.textContent = routeNames[route] || 'æœªçŸ¥çº¿è·¯';
    
    // æ¸…ç©ºæœç´¢ç»“æœ
    musicList = [];
    renderEmptyState('è¯·æœç´¢æ‚¨å–œæ¬¢çš„éŸ³ä¹', 'è¾“å…¥æ­Œæ›²åç§°ã€æ­Œæ‰‹æˆ–ä¸“è¾‘åç§°å¼€å§‹æ¢ç´¢');
    
    layer.msg(`å·²åˆ‡æ¢åˆ° ${routeNames[route]}`, {icon: 1});
  }
  
  // æ’­æ”¾å™¨æ§åˆ¶å‡½æ•°
  function togglePlayPause() {
    if (!audioPlayer.src) {
      layer.msg('è¯·å…ˆé€‰æ‹©è¦æ’­æ”¾çš„éŸ³ä¹', {icon: 0});
      return;
    }
    
    if (isPlaying) {
      audioPlayer.pause();
    } else {
      audioPlayer.play().catch(error => {
        console.error('æ’­æ”¾é”™è¯¯:', error);
        layer.msg('æ’­æ”¾å¤±è´¥', {icon: 2});
      });
    }
  }
  
  function playPrevious() {
    if (currentPlayingIndex <= 0) {
      layer.msg('å·²ç»æ˜¯ç¬¬ä¸€é¦–äº†', {icon: 0});
      return;
    }
    playMusic(currentPlayingIndex - 1);
  }
  
  function playNext() {
    let nextIndex;
    
    if (playMode === 'repeat') {
      // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
      nextIndex = currentPlayingIndex;
    } else if (playMode === 'random') {
      // éšæœºæ’­æ”¾
      if (musicList.length <= 1) {
        nextIndex = currentPlayingIndex;
      } else {
        do {
          nextIndex = Math.floor(Math.random() * musicList.length);
        } while (nextIndex === currentPlayingIndex);
      }
    } else {
      // é¡ºåºæ’­æ”¾
      nextIndex = currentPlayingIndex + 1;
      if (nextIndex >= musicList.length) {
        layer.msg('å·²ç»æ˜¯æœ€åä¸€é¦–äº†', {icon: 0});
        return;
      }
    }
    
    if (nextIndex !== undefined && nextIndex >= 0 && nextIndex < musicList.length) {
      playMusic(nextIndex);
    }
  }
  
  function playPrevious() {
    let prevIndex;
    
    if (playMode === 'repeat') {
      // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
      prevIndex = currentPlayingIndex;
    } else if (playMode === 'random') {
      // éšæœºæ’­æ”¾
      if (musicList.length <= 1) {
        prevIndex = currentPlayingIndex;
      } else {
        do {
          prevIndex = Math.floor(Math.random() * musicList.length);
        } while (prevIndex === currentPlayingIndex);
      }
    } else {
      // é¡ºåºæ’­æ”¾
      prevIndex = currentPlayingIndex - 1;
      if (prevIndex < 0) {
        layer.msg('å·²ç»æ˜¯ç¬¬ä¸€é¦–äº†', {icon: 0});
        return;
      }
    }
    
    if (prevIndex !== undefined && prevIndex >= 0 && prevIndex < musicList.length) {
      playMusic(prevIndex);
    }
  }
  
  // å¤„ç†éŸ³é¢‘ç»“æŸäº‹ä»¶
  function handleAudioEnded() {
    if (playMode === 'repeat') {
      // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾
      audioPlayer.currentTime = 0;
      audioPlayer.play().catch(error => {
        console.error('æ’­æ”¾é”™è¯¯:', error);
      });
    } else {
      // é¡ºåºæˆ–éšæœºæ’­æ”¾ä¸‹ä¸€é¦–
      playNext();
    }
  }
  
  // æ’­æ”¾è¿›åº¦æ§åˆ¶å‡½æ•°
  function updateProgress() {
    if (audioPlayer.duration) {
      const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      progressBar.style.width = progress + '%';
      updateCurrentTime();
    }
  }
  
  function updateCurrentTime() {
    currentTimeSpan.textContent = formatTime(audioPlayer.currentTime || 0);
  }
  
  function updateTotalTime() {
    totalTimeSpan.textContent = formatTime(audioPlayer.duration || 0);
  }
  
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  function seekTo(e) {
    if (!audioPlayer.duration) return;
    
    const rect = progressContainer.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    const newTime = percent * audioPlayer.duration;
    
    audioPlayer.currentTime = Math.max(0, Math.min(newTime, audioPlayer.duration));
    updateProgress();
  }
  
  function startDrag(e) {
    isDragging = true;
    dragProgress(e);
  }
  
  function dragProgress(e) {
    if (!isDragging || !audioPlayer.duration) return;
    
    const rect = progressContainer.getBoundingClientRect();
    const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    const newTime = percent * audioPlayer.duration;
    
    audioPlayer.currentTime = newTime;
    progressBar.style.width = (percent * 100) + '%';
    updateCurrentTime();
  }
  
  function endDrag() {
    isDragging = false;
  }
  
  // æ’­æ”¾æ¨¡å¼æ§åˆ¶å‡½æ•°
  function setPlayMode(mode) {
    playMode = mode;
    updatePlayModeDisplay();
    
    const modeNames = {
      'sequence': 'é¡ºåºæ’­æ”¾',
      'random': 'éšæœºæ’­æ”¾',
      'repeat': 'å•æ›²å¾ªç¯'
    };
    
    layer.msg(`å·²åˆ‡æ¢åˆ°ï¼š${modeNames[mode]}`, {icon: 1, time: 1500});
  }
  
  function updatePlayModeDisplay() {
    // æ¸…é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
    [sequenceBtn, randomBtn, repeatBtn].forEach(btn => {
      btn.classList.remove('active');
    });
    
    // æ¿€æ´»å½“å‰æ¨¡å¼æŒ‰é’®
    const modeButtons = {
      'sequence': sequenceBtn,
      'random': randomBtn,
      'repeat': repeatBtn
    };
    
    const modeTexts = {
      'sequence': 'é¡ºåºæ’­æ”¾',
      'random': 'éšæœºæ’­æ”¾',
      'repeat': 'å•æ›²å¾ªç¯'
    };
    
    if (modeButtons[playMode]) {
      modeButtons[playMode].classList.add('active');
    }
    
    playmodeText.textContent = modeTexts[playMode] || 'é¡ºåºæ’­æ”¾';
  }
  
  // éŸ³é‡æ§åˆ¶å‡½æ•°
  function toggleMute() {
    if (isMuted) {
      audioPlayer.volume = volume;
      isMuted = false;
      volumeBtn.querySelector('i').className = 'iconfont icon-24gf-volumeLow';
    } else {
      audioPlayer.volume = 0;
      isMuted = true;
      volumeBtn.querySelector('i').className = 'iconfont icon-24gf-volumeCross';
    }
    updateVolumeDisplay();
  }
  
  function setVolume(e) {
    const rect = volumeSlider.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    volume = Math.max(0, Math.min(1, percent));
    
    audioPlayer.volume = volume;
    isMuted = false;
    
    // æ›´æ–°éŸ³é‡æŒ‰é’®å›¾æ ‡
    if (volume === 0) {
      volumeBtn.querySelector('i').className = 'iconfont icon-24gf-volumeCross';
    } else {
      volumeBtn.querySelector('i').className = 'iconfont icon-24gf-volumeLow';
    }
    
    updateVolumeDisplay();
  }
  
  function updateVolumeDisplay() {
    const displayVolume = isMuted ? 0 : volume;
    volumeProgress.style.width = (displayVolume * 100) + '%';
  }
  
  function showPlayer() {
    musicPlayer.style.display = 'block';
    musicPlayer.style.transform = 'translateY(0)';
    musicPlayer.classList.add('show');
  }
  
  function closePlayer() {
    audioPlayer.pause();
    audioPlayer.src = '';
    musicPlayer.style.transform = 'translateY(100%)';
    musicPlayer.classList.remove('show');
    // å»¶è¿Ÿéšè—ï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆ
    setTimeout(() => {
      musicPlayer.style.display = 'none';
    }, 400);
    currentPlayingIndex = -1;
    isPlaying = false;
    updatePlayPauseButton();
    
    // é‡ç½®è¿›åº¦æ¡
    progressBar.style.width = '0%';
    currentTimeSpan.textContent = '00:00';
    totalTimeSpan.textContent = '00:00';
    
    // é‡ç½®æ’­æ”¾å™¨ä¿¡æ¯
    playerTitle.textContent = 'æœªæ’­æ”¾éŸ³ä¹';
    playerArtist.textContent = 'é€‰æ‹©éŸ³ä¹å¼€å§‹æ’­æ”¾';
    playerCover.style.display = 'none';
  }
  
  function updatePlayPauseButton() {
    const icon = playPauseBtn.querySelector('i');
    if (isPlaying) {
      icon.className = 'layui-icon layui-icon-pause';
    } else {
      icon.className = 'layui-icon layui-icon-play';
    }
  }
  
  // å®‰å…¨è½¬ä¹‰HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
});
</script>
{% endblock %}


