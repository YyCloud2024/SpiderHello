{% extends "pc/template.html" %}

{% block title %}
虚拟邮箱
{% endblock %}


{% block css %}
<style>
:root {
  --primary-purple: #6366f1;
  --secondary-purple: #8b5cf6;
  --light-purple: #c4b5fd;
  --sky-blue: #0ea5e9;
  --light-blue: #7dd3fc;
  --matcha-green: #10b981;
  --light-green: #6ee7b7;
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --card-bg: rgba(99, 102, 241, 0.1);
  --gradient-primary: linear-gradient(135deg, var(--primary-purple), var(--sky-blue));
  --gradient-secondary: linear-gradient(135deg, var(--matcha-green), var(--light-blue));
  --shadow-purple: 0 10px 25px rgba(99, 102, 241, 0.3);
  --shadow-blue: 0 8px 20px rgba(14, 165, 233, 0.2);
}

#BloodSpiderBody {
  background: linear-gradient(135deg, #f0f9ff 0%, #ede9fe 50%, #ecfdf5 100%);
  min-height: 100vh;
  font-family: 'Microsoft YaHei', sans-serif;
}

#BloodSpiderBody .virtual-email-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

#BloodSpiderBody .header-banner {
  background: var(--gradient-primary);
  border-radius: 16px;
  padding: 24px;
  color: white;
  box-shadow: var(--shadow-purple);
  margin-bottom: 24px;
  position: relative;
  overflow: hidden;
}

#BloodSpiderBody .header-banner::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="spider" patternUnits="userSpaceOnUse" width="20" height="20"><path d="M10,2 L18,10 L10,18 L2,10 Z" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23spider)"/></svg>') repeat;
  opacity: 0.3;
}

#BloodSpiderBody .header-content {
  position: relative;
  z-index: 1;
}

#BloodSpiderBody .header-title {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 8px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

#BloodSpiderBody .header-subtitle {
  font-size: 16px;
  opacity: 0.9;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

#BloodSpiderBody .provider-selection {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

#BloodSpiderBody .provider-card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  border: 2px solid transparent;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
}

#BloodSpiderBody .provider-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-purple);
}

#BloodSpiderBody .provider-card.active {
  border-color: var(--primary-purple);
  background: var(--card-bg);
}

#BloodSpiderBody .provider-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

#BloodSpiderBody .provider-name {
  font-size: 18px;
  font-weight: bold;
  color: var(--text-primary);
}

#BloodSpiderBody .provider-status {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

#BloodSpiderBody .status-stable {
  background: rgba(16, 185, 129, 0.1);
  color: var(--matcha-green);
}

#BloodSpiderBody .status-temp {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

#BloodSpiderBody .provider-desc {
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 12px;
}

#BloodSpiderBody .provider-features {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

#BloodSpiderBody .feature-tag {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary-purple);
  padding: 4px 8px;
  border-radius: 8px;
  font-size: 12px;
}

#BloodSpiderBody .operation-area {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin-bottom: 24px;
}

#BloodSpiderBody .operation-buttons {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

#BloodSpiderBody .primary-btn {
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  min-height: 44px;
}

#BloodSpiderBody .primary-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-purple);
}

#BloodSpiderBody .secondary-btn {
  background: var(--gradient-secondary);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  min-height: 44px;
}

#BloodSpiderBody .secondary-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-blue);
}

#BloodSpiderBody .btn-disabled {
  background: #d1d5db !important;
  cursor: not-allowed !important;
  transform: none !important;
}

#BloodSpiderBody .email-info {
  background: rgba(99, 102, 241, 0.05);
  border: 1px solid var(--light-purple);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  display: none;
}

#BloodSpiderBody .email-info.show {
  display: block;
}

#BloodSpiderBody .email-address {
  font-size: 18px;
  font-weight: bold;
  color: var(--primary-purple);
  margin-bottom: 8px;
  word-break: break-all;
}

#BloodSpiderBody .email-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

#BloodSpiderBody .copy-btn {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary-purple);
  border: 1px solid var(--light-purple);
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

#BloodSpiderBody .copy-btn:hover {
  background: var(--primary-purple);
  color: white;
}

#BloodSpiderBody .email-list {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  overflow: hidden;
}

#BloodSpiderBody .email-list-header {
  background: var(--gradient-primary);
  color: white;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#BloodSpiderBody .email-list-title {
  font-size: 18px;
  font-weight: bold;
}

#BloodSpiderBody .refresh-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: white;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 4px;
}

#BloodSpiderBody .refresh-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

#BloodSpiderBody .email-list-content {
  max-height: 500px;
  overflow-y: auto;
}

#BloodSpiderBody .email-item {
  padding: 16px 20px;
  border-bottom: 1px solid #f3f4f6;
  transition: all 0.3s ease;
}

#BloodSpiderBody .email-item:hover {
  background: rgba(99, 102, 241, 0.05);
}

#BloodSpiderBody .email-item:last-child {
  border-bottom: none;
}

#BloodSpiderBody .email-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

#BloodSpiderBody .email-subject {
  font-weight: bold;
  color: var(--text-primary);
  font-size: 16px;
}

#BloodSpiderBody .email-from {
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 8px;
}

#BloodSpiderBody .email-content {
  color: var(--text-primary);
  font-size: 14px;
  line-height: 1.5;
  max-height: 100px;
  overflow: hidden;
  position: relative;
}

#BloodSpiderBody .email-content.expanded {
  max-height: none;
}

#BloodSpiderBody .expand-btn {
  color: var(--primary-purple);
  cursor: pointer;
  font-size: 12px;
  margin-top: 8px;
}

#BloodSpiderBody .no-emails {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
}

#BloodSpiderBody .no-emails i {
  font-size: 48px;
  color: var(--light-purple);
  margin-bottom: 16px;
}

#BloodSpiderBody .loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  color: var(--text-secondary);
}

#BloodSpiderBody .loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--light-purple);
  border-top: 2px solid var(--primary-purple);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#BloodSpiderBody .message {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#BloodSpiderBody .message-success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--matcha-green);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

#BloodSpiderBody .message-error {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.2);
}

#BloodSpiderBody .message-warning {
  background: rgba(245, 158, 11, 0.1);
  color: #f59e0b;
  border: 1px solid rgba(245, 158, 11, 0.2);
}

@media (max-width: 1199px) {
  #BloodSpiderBody .virtual-email-container {
    padding: 16px;
  }
  #BloodSpiderBody .header-title {
    font-size: 24px;
  }
  #BloodSpiderBody .provider-selection {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 767px) {
  #BloodSpiderBody .virtual-email-container {
    padding: 12px;
  }
  #BloodSpiderBody .header-title {
    font-size: 20px;
  }
  #BloodSpiderBody .header-banner {
    padding: 16px;
  }
  #BloodSpiderBody .operation-buttons {
    flex-direction: column;
  }
  #BloodSpiderBody .primary-btn,
  #BloodSpiderBody .secondary-btn {
    width: 100%;
    justify-content: center;
  }
  #BloodSpiderBody .email-header {
    flex-direction: column;
    gap: 4px;
  }
  #BloodSpiderBody .email-actions {
    flex-direction: column;
  }
}
</style>
{% endblock %}


{% block content %}
<div class="virtual-email-container">
    <!-- 头部Banner -->
    <div class="header-banner">
        <div class="header-content">
            <h1 class="header-title">
                <i class="iconfont icon-youxiang"></i>
                虚拟邮箱服务
            </h1>
            <p class="header-subtitle">多线路临时邮箱，快速接收验证码和邮件</p>
        </div>
    </div>

    <!-- 邮箱服务商选择 -->
    <div class="provider-selection">
        <div class="provider-card" data-provider="awamail_com">
            <div class="provider-header">
                <div class="provider-name">AWA邮箱</div>
                <div class="provider-status status-stable">稳定</div>
            </div>
            <div class="provider-desc">@awa.pics 域名，响应速度快，适合各类验证</div>
            <div class="provider-features">
                <span class="feature-tag">Cookie认证</span>
                <span class="feature-tag">长期有效</span>
                <span class="feature-tag">稳定可靠</span>
            </div>
        </div>

        <div class="provider-card" data-provider="internxt_com">
            <div class="provider-header">
                <div class="provider-name">Internxt邮箱</div>
                <div class="provider-status status-stable">稳定</div>
            </div>
            <div class="provider-desc">@somoj.com 域名，企业级服务，安全性高</div>
            <div class="provider-features">
                <span class="feature-tag">JWT认证</span>
                <span class="feature-tag">高安全性</span>
                <span class="feature-tag">企业级</span>
            </div>
        </div>

        <div class="provider-card" data-provider="minmail_app">
            <div class="provider-header">
                <div class="provider-name">MinMail邮箱</div>
                <div class="provider-status status-temp">10分钟</div>
            </div>
            <div class="provider-desc">@atminmail.com 域名，快速临时邮箱</div>
            <div class="provider-features">
                <span class="feature-tag">visitor-id</span>
                <span class="feature-tag">10分钟有效</span>
                <span class="feature-tag">即用即抛</span>
            </div>
        </div>
    </div>

    <!-- 操作区域 -->
    <div class="operation-area">
        <div class="operation-buttons">
            <button class="primary-btn" id="createEmailBtn">
                <i class="iconfont icon-tianjia"></i>
                创建邮箱
            </button>
            <button class="secondary-btn" id="getEmailsBtn" disabled>
                <i class="iconfont icon-shuaxin"></i>
                获取邮件
            </button>
        </div>

        <!-- 邮箱信息显示 -->
        <div class="email-info" id="emailInfo">
            <div class="email-address" id="emailAddress"></div>
            <div class="email-actions">
                <button class="copy-btn" id="copyEmailBtn">
                    <i class="iconfont icon-fuzhi"></i>
                    复制邮箱
                </button>
                <span class="provider-info" id="providerInfo"></span>
            </div>
        </div>
    </div>

    <!-- 邮件列表 -->
    <div class="email-list">
        <div class="email-list-header">
            <div class="email-list-title">
                <i class="iconfont icon-youjian"></i>
                收件箱
            </div>
            <button class="refresh-btn" id="refreshBtn">
                <i class="iconfont icon-shuaxin"></i>
                刷新
            </button>
        </div>
        <div class="email-list-content" id="emailListContent">
            <div class="no-emails">
                <div>
                    <i class="iconfont icon-kongbai"></i>
                </div>
                <p>暂无邮件，请先创建邮箱</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
{% endblock %}

{% block js %}
<script>
class VirtualEmailManager {
    constructor() {
        this.currentProvider = null;
        this.currentEmailData = null;
        this.autoRefreshInterval = null;
        this.init();
    }

    init() {
        this.bindEvents();
        this.selectProvider('awamail_com');
    }

    bindEvents() {
        document.querySelectorAll('.provider-card').forEach(card => {
            card.addEventListener('click', () => {
                const provider = card.dataset.provider;
                this.selectProvider(provider);
            });
        });

        document.getElementById('createEmailBtn').addEventListener('click', () => {
            this.createEmail();
        });

        document.getElementById('getEmailsBtn').addEventListener('click', () => {
            this.getEmails();
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.getEmails();
        });

        document.getElementById('copyEmailBtn').addEventListener('click', () => {
            this.copyEmail();
        });
    }

    selectProvider(provider) {
        document.querySelectorAll('.provider-card').forEach(card => {
            card.classList.remove('active');
        });
        document.querySelector(`[data-provider="${provider}"]`).classList.add('active');

        this.currentProvider = provider;
        this.currentEmailData = null;
        
        this.hideEmailInfo();
        this.clearEmails();
        this.resetButtons();
        this.updateProviderInfo(provider);
    }

    updateProviderInfo(provider) {
        const providerNames = {
            'awamail_com': 'AWA邮箱',
            'internxt_com': 'Internxt邮箱', 
            'minmail_app': 'MinMail邮箱'
        };
        
        const providerInfo = document.getElementById('providerInfo');
        providerInfo.textContent = `当前线路：${providerNames[provider]}`;
    }

    async createEmail() {
        if (!this.currentProvider) {
            this.showMessage('请先选择邮箱服务商', 'error');
            return;
        }

        const createBtn = document.getElementById('createEmailBtn');
        this.setButtonLoading(createBtn, true);

        try {
            const response = await axios.post(`/api/virtual_emails/${this.currentProvider}/create/`, {}, {
                timeout: 30000,
                headers: {
                    'Authorization': 'Bearer b9391759-3d18-4edd-8768-b59abc100ba3'
                }
            });

            if (response.data.code === 0) {
                this.currentEmailData = response.data.data;
                this.showEmailInfo(this.currentEmailData.email);
                this.enableGetEmailsButton();
                this.showMessage('邮箱创建成功！', 'success');
                
                if (this.currentProvider === 'minmail_app') {
                    this.startCountdown(600);
                }
                
                setTimeout(() => this.getEmails(), 1000);
            } else {
                this.showMessage(`创建失败：${response.data.message}`, 'error');
            }
        } catch (error) {
            console.error('创建邮箱失败:', error);
            this.showMessage('创建邮箱失败，请稍后重试', 'error');
        } finally {
            this.setButtonLoading(createBtn, false);
        }
    }

    async getEmails() {
        if (!this.currentEmailData) {
            this.showMessage('请先创建邮箱', 'warning');
            return;
        }

        const getBtn = document.getElementById('getEmailsBtn');
        this.setButtonLoading(getBtn, true);

        try {
            const headers = {
                'Authorization': 'Bearer b9391759-3d18-4edd-8768-b59abc100ba3',
                'Content-Type': 'application/json'
            };
            
            let requestData = {};

            // 根据不同服务商设置不同的认证方式
            if (this.currentProvider === 'awamail_com' && this.currentEmailData.config.cookie) {
                // awamail_com: 将cookie信息放在请求体中
                requestData.cookie_data = {
                    awamail_session: this.currentEmailData.config.cookie.awamail_session
                };
            } else if (this.currentProvider === 'internxt_com') {
                // internxt_com: 使用请求头认证
                headers['account'] = this.currentEmailData.email;
                headers['password'] = this.currentEmailData.config.password;
                if (this.currentEmailData.config.authorization) {
                    headers['Authorization'] = this.currentEmailData.config.authorization;
                }
            } else if (this.currentProvider === 'minmail_app' && this.currentEmailData.config.headers) {
                // minmail_app: 使用visitor-id头
                headers['visitor-id'] = this.currentEmailData.config.headers['visitor-id'];
            }

            const response = await axios.post(`/api/virtual_emails/${this.currentProvider}/get/`, requestData, {
                timeout: 30000,
                headers: headers
            });

            if (response.data.code === 0) {
                this.displayEmails(response.data.data.emails);
                this.showMessage(`获取到 ${response.data.data.emails.length} 封邮件`, 'success');
            } else {
                this.showMessage(`获取失败：${response.data.message}`, 'error');
            }
        } catch (error) {
            console.error('获取邮件失败:', error);
            if (error.response && error.response.status === 403) {
                this.showMessage('权限不足，请重新创建邮箱', 'error');
            } else {
                this.showMessage('获取邮件失败，请稍后重试', 'error');
            }
        } finally {
            this.setButtonLoading(getBtn, false);
        }
    }

    displayEmails(emails) {
        const container = document.getElementById('emailListContent');
        
        if (!emails || emails.length === 0) {
            container.innerHTML = `
                <div class="no-emails">
                    <div><i class="iconfont icon-kongbai"></i></div>
                    <p>暂无邮件</p>
                </div>
            `;
            return;
        }

        container.innerHTML = emails.map((email, index) => `
            <div class="email-item">
                <div class="email-header">
                    <div class="email-subject">${this.escapeHtml(email.subject || '无主题')}</div>
                </div>
                <div class="email-from">发件人：${this.escapeHtml(email.from_address || '未知')}</div>
                <div class="email-content" id="emailContent${index}">
                    ${email.email_text || '无内容'}
                </div>
                ${email.email_text && email.email_text.length > 200 ? `
                    <div class="expand-btn" onclick="virtualEmailManager.toggleEmailContent(${index})">
                        展开完整内容
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    toggleEmailContent(index) {
        const content = document.getElementById(`emailContent${index}`);
        const expandBtn = content.nextElementSibling;
        
        if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            expandBtn.textContent = '展开完整内容';
        } else {
            content.classList.add('expanded');
            expandBtn.textContent = '收起内容';
        }
    }

    showEmailInfo(email) {
        document.getElementById('emailAddress').textContent = email;
        document.getElementById('emailInfo').classList.add('show');
    }

    hideEmailInfo() {
        document.getElementById('emailInfo').classList.remove('show');
    }

    copyEmail() {
        const emailAddress = document.getElementById('emailAddress').textContent;
        if (emailAddress) {
            navigator.clipboard.writeText(emailAddress).then(() => {
                this.showMessage('邮箱地址已复制到剪贴板', 'success');
            }).catch(() => {
                this.showMessage('复制失败，请手动复制', 'error');
            });
        }
    }

    enableGetEmailsButton() {
        const btn = document.getElementById('getEmailsBtn');
        btn.disabled = false;
        btn.classList.remove('btn-disabled');
    }

    resetButtons() {
        const getBtn = document.getElementById('getEmailsBtn');
        getBtn.disabled = true;
        getBtn.classList.add('btn-disabled');
    }

    setButtonLoading(button, loading) {
        if (loading) {
            button.disabled = true;
            button.innerHTML = `
                <div class="loading-spinner"></div>
                加载中...
            `;
        } else {
            button.disabled = false;
            const originalText = button.id === 'createEmailBtn' ? '创建邮箱' : '获取邮件';
            const icon = button.id === 'createEmailBtn' ? 'icon-tianjia' : 'icon-shuaxin';
            button.innerHTML = `
                <i class="iconfont ${icon}"></i>
                ${originalText}
            `;
        }
    }

    clearEmails() {
        const container = document.getElementById('emailListContent');
        container.innerHTML = `
            <div class="no-emails">
                <div><i class="iconfont icon-kongbai"></i></div>
                <p>暂无邮件，请先创建邮箱</p>
            </div>
        `;
    }

    startCountdown(seconds) {
        const providerInfo = document.getElementById('providerInfo');
        let remaining = seconds;
        
        const updateCountdown = () => {
            const minutes = Math.floor(remaining / 60);
            const secs = remaining % 60;
            providerInfo.textContent = `当前线路：MinMail邮箱 (剩余${minutes}:${secs.toString().padStart(2, '0')})`;
            
            if (remaining <= 0) {
                this.showMessage('邮箱已过期，请重新创建', 'warning');
                clearInterval(this.countdownInterval);
                return;
            }
            remaining--;
        };
        
        updateCountdown();
        this.countdownInterval = setInterval(updateCountdown, 1000);
    }

    showMessage(text, type = 'success') {
        const existingMessage = document.querySelector('.message');
        if (existingMessage) {
            existingMessage.remove();
        }

        const message = document.createElement('div');
        message.className = `message message-${type}`;
        
        const icon = type === 'success' ? 'icon-chenggong' : 
                    type === 'error' ? 'icon-cuowu' : 'icon-jinggao';
        
        message.innerHTML = `
            <i class="iconfont ${icon}"></i>
            ${text}
        `;

        const container = document.querySelector('.operation-area');
        container.insertBefore(message, container.firstChild);

        setTimeout(() => {
            message.remove();
        }, 3000);
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

const virtualEmailManager = new VirtualEmailManager();
</script>
{% endblock %}

