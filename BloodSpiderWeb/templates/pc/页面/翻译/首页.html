{% extends "pc/template.html" %}

{% block title %}
ç¿»è¯‘é¦–é¡µ - è››ç½‘ç¿»è¯‘å¹³å°
{% endblock %}

{% block css %}
<style>
/* ä¸»é¢˜è‰²å½©é…ç½® - èåˆç´«è‰²ç¥ç§˜è´¨æ„Ÿã€å¤©è“è‰²æ¸…é€æ„Ÿä¸æŠ¹èŒ¶ç»¿ */
:root {
  --primary-purple: #6366f1;
  --secondary-purple: #8b5cf6;
  --light-purple: #c4b5fd;
  --sky-blue: #0ea5e9;
  --light-blue: #7dd3fc;
  --matcha-green: #10b981;
  --light-green: #6ee7b7;
  --dark-bg: #1e1b4b;
  --card-bg: rgba(99, 102, 241, 0.1);
  --glass-bg: rgba(255, 255, 255, 0.1);
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --shadow-purple: 0 10px 25px rgba(99, 102, 241, 0.3);
  --shadow-blue: 0 8px 20px rgba(14, 165, 233, 0.2);
  --gradient-primary: linear-gradient(135deg, var(--primary-purple), var(--sky-blue));
  --gradient-secondary: linear-gradient(135deg, var(--matcha-green), var(--light-blue));
}

/* ç¿»è¯‘é¡µé¢ä¸»å®¹å™¨ */
.translate-container {
  background: linear-gradient(135deg, #f0f9ff 0%, #ede9fe 50%, #ecfdf5 100%);
  min-height: 100vh;
  padding: 20px;
}

/* å¤´éƒ¨åŒºåŸŸ */
.translate-header {
  background: var(--gradient-primary);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-purple);
  color: white;
  position: relative;
  overflow: hidden;
}

.translate-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="spider" patternUnits="userSpaceOnUse" width="20" height="20"><path d="M10,2 L18,10 L10,18 L2,10 Z" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23spider)"/></svg>') repeat;
  opacity: 0.3;
}

.translate-header .content {
  position: relative;
  z-index: 1;
}

.translate-title {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.translate-subtitle {
  font-size: 16px;
  opacity: 0.9;
}

/* çº¿è·¯åˆ‡æ¢åŒºåŸŸ */
.route-switcher {
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-blue);
}

.route-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 20px;
}

.route-tab {
  padding: 10px 20px;
  border: 2px solid var(--primary-purple);
  border-radius: 25px;
  background: transparent;
  color: var(--primary-purple);
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  min-width: 120px;
  text-align: center;
}

.route-tab:hover {
  background: var(--primary-purple);
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-purple);
}

.route-tab.active {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-purple);
}

/* è¯­è¨€é€‰æ‹©åŒºåŸŸ */
.language-section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 1px solid var(--light-purple);
}

.language-selector {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 16px;
  align-items: center;
  margin-bottom: 20px;
}

.language-select {
  padding: 12px 16px;
  border: 2px solid var(--light-purple);
  border-radius: 8px;
  font-size: 16px;
  background: white;
  transition: all 0.3s ease;
  cursor: pointer;
}

.language-select:focus {
  outline: none;
  border-color: var(--primary-purple);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.language-swap {
  width: 44px;
  height: 44px;
  background: var(--gradient-secondary);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 18px;
}

.language-swap:hover {
  transform: rotate(180deg) scale(1.1);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

/* ç¿»è¯‘è¾“å…¥åŒºåŸŸ */
.translate-section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 1px solid var(--light-blue);
}

.translate-panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.translate-panel {
  border: 2px solid var(--light-purple);
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.translate-panel:focus-within {
  border-color: var(--primary-purple);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.panel-header {
  background: var(--card-bg);
  padding: 12px 16px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel-textarea {
  width: 100%;
  min-height: 150px;
  padding: 16px;
  border: none;
  outline: none;
  resize: vertical;
  font-size: 16px;
  line-height: 1.5;
  font-family: inherit;
}

.panel-footer {
  background: #f9fafb;
  padding: 8px 16px;
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.char-count {
  font-family: monospace;
}

.panel-actions {
  display: flex;
  gap: 8px;
}

.action-btn {
  padding: 4px 8px;
  background: transparent;
  border: 1px solid var(--light-purple);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 12px;
}

.action-btn:hover {
  background: var(--primary-purple);
  color: white;
  border-color: var(--primary-purple);
}

/* ç¿»è¯‘æ§åˆ¶åŒºåŸŸ */
.translate-controls {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-bottom: 20px;
}

.translate-btn {
  padding: 12px 24px;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  min-width: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.translate-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-purple);
}

.translate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.clear-btn {
  background: var(--gradient-secondary);
}

.clear-btn:hover {
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
}

/* ç¿»è¯‘å†å²åŒºåŸŸ */
.history-section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 1px solid var(--light-green);
}

.section-title {
  font-size: 20px;
  font-weight: bold;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--light-purple);
  display: flex;
  align-items: center;
  gap: 8px;
}

.history-list {
  display: grid;
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
}

.history-item {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  transition: all 0.3s ease;
  cursor: pointer;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(14, 165, 233, 0.02));
}

.history-item:hover {
  border-color: var(--primary-purple);
  box-shadow: var(--shadow-purple);
  transform: translateY(-1px);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(14, 165, 233, 0.05));
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.history-route {
  font-size: 12px;
  background: var(--gradient-primary);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
}

.history-time {
  font-size: 12px;
  color: var(--text-secondary);
  font-family: monospace;
}

.history-content {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 12px;
  align-items: center;
}

.history-text {
  font-size: 14px;
  color: var(--text-primary);
  line-height: 1.4;
  max-height: 60px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

.history-arrow {
  color: var(--primary-purple);
  font-size: 16px;
}

/* åŠ è½½å’Œç©ºçŠ¶æ€ */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.loading-spinner {
  display: inline-block;
  width: 32px;
  height: 32px;
  border: 3px solid var(--light-purple);
  border-top: 3px solid var(--primary-purple);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 48px;
  color: var(--light-purple);
  margin-bottom: 16px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1199px) {
  .translate-container {
    padding: 16px;
  }
  
  .translate-header {
    padding: 20px;
  }
  
  .translate-title {
    font-size: 24px;
  }
  
  .translate-panels {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .language-selector {
    grid-template-columns: 1fr;
    gap: 12px;
  }
}

@media (max-width: 767px) {
  .translate-container {
    padding: 12px;
  }
  
  .translate-header {
    padding: 16px;
  }
  
  .translate-title {
    font-size: 20px;
  }
  
  .route-tabs {
    justify-content: center;
  }
  
  .route-tab {
    min-width: 100px;
    font-size: 14px;
    padding: 8px 16px;
  }
  
  .translate-controls {
    flex-direction: column;
  }
  
  .translate-btn {
    width: 100%;
  }
  
  .history-content {
    grid-template-columns: 1fr;
    text-align: center;
  }
  
  .history-arrow {
    transform: rotate(90deg);
  }
}

/* è§¦æ§ä¼˜åŒ– */
@media (max-width: 767px) {
  .route-tab,
  .translate-btn,
  .language-swap,
  .action-btn {
    min-height: 44px;
    min-width: 44px;
  }
}

/* é«˜åˆ†è¾¨ç‡é€‚é… */
@media (min-width: 1400px) {
  .translate-container {
    max-width: 1200px;
    margin: 0 auto;
  }
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
.history-list::-webkit-scrollbar {
  width: 6px;
}

.history-list::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 3px;
}

.history-list::-webkit-scrollbar-thumb {
  background: var(--primary-purple);
  border-radius: 3px;
}

.history-list::-webkit-scrollbar-thumb:hover {
  background: var(--secondary-purple);
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-in {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.slide-in {
  animation: slideIn 0.4s ease;
}

@keyframes slideIn {
  from { transform: translateX(-20px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
</style>
{% endblock %}

{% block content %}
<div class="translate-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <div class="translate-header">
    <div class="content">
      <h1 class="translate-title">
        <i class="layui-icon layui-icon-fonts-code"></i>
        è››ç½‘ç¿»è¯‘
      </h1>
      <p class="translate-subtitle">è·¨è¶Šè¯­è¨€è¾¹ç•Œï¼Œè¿æ¥ä¸–ç•Œæ–‡æ˜</p>
    </div>
  </div>

  <!-- çº¿è·¯åˆ‡æ¢åŒºåŸŸ -->
  <div class="route-switcher">
    <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">
      <i class="layui-icon layui-icon-website"></i>
      ç¿»è¯‘çº¿è·¯é€‰æ‹©
    </h3>
    <div class="route-tabs">
      <div class="route-tab active" data-route="youdao">
        <i class="layui-icon layui-icon-fonts-code"></i>
        æœ‰é“ç¿»è¯‘
      </div>
      <div class="route-tab" data-route="coming_soon_1">
        <i class="layui-icon layui-icon-transfer"></i>
        è°·æ­Œç¿»è¯‘
        <span style="font-size: 10px; opacity: 0.7;">(å³å°†ä¸Šçº¿)</span>
      </div>
      <div class="route-tab" data-route="coming_soon_2">
        <i class="layui-icon layui-icon-dialogue"></i>
        ç™¾åº¦ç¿»è¯‘
        <span style="font-size: 10px; opacity: 0.7;">(å³å°†ä¸Šçº¿)</span>
      </div>
    </div>
    <div class="route-info">
      <p style="color: var(--text-secondary); margin: 0; font-size: 14px;">
        <i class="layui-icon layui-icon-tips"></i>
        å½“å‰é€‰æ‹©: <span id="current-route-name">æœ‰é“ç¿»è¯‘</span> - æä¾›ä¸“ä¸šå‡†ç¡®çš„ç¿»è¯‘æœåŠ¡
      </p>
    </div>
  </div>

  <!-- è¯­è¨€é€‰æ‹©åŒºåŸŸ -->
  <div class="language-section">
    <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">
      <i class="layui-icon layui-icon-set"></i>
      è¯­è¨€é€‰æ‹©
    </h3>
    <div class="language-selector">
      <select class="language-select" id="source-language">
        <option value="AUTO">è‡ªåŠ¨æ£€æµ‹</option>
      </select>
      <button class="language-swap" id="swap-languages" title="äº¤æ¢è¯­è¨€">
        <i class="layui-icon layui-icon-refresh-1"></i>
      </button>
      <select class="language-select" id="target-language">
        <option value="EN">è‹±è¯­</option>
      </select>
    </div>
    <div style="text-align: center; color: var(--text-secondary); font-size: 14px;">
      <i class="layui-icon layui-icon-tips"></i>
      <span id="language-status">æ­£åœ¨åŠ è½½æ”¯æŒçš„è¯­è¨€...</span>
    </div>
  </div>

  <!-- ç¿»è¯‘è¾“å…¥åŒºåŸŸ -->
  <div class="translate-section">
    <h3 class="section-title">
      <i class="layui-icon layui-icon-edit"></i>
      æ–‡æœ¬ç¿»è¯‘
    </h3>
    <div class="translate-panels">
      <!-- æºæ–‡æœ¬é¢æ¿ -->
      <div class="translate-panel">
        <div class="panel-header">
          <i class="layui-icon layui-icon-edit"></i>
          <span id="source-label">åŸæ–‡ (è‡ªåŠ¨æ£€æµ‹)</span>
        </div>
        <textarea 
          class="panel-textarea" 
          id="source-text"
          placeholder="åœ¨æ­¤è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬..."
          maxlength="5000"
        ></textarea>
        <div class="panel-footer">
          <span class="char-count">
            <span id="source-count">0</span>/5000
          </span>
          <div class="panel-actions">
            <button class="action-btn" id="paste-btn" title="ç²˜è´´">
              <i class="layui-icon layui-icon-template-1"></i>
            </button>
            <button class="action-btn" id="clear-source-btn" title="æ¸…ç©º">
              <i class="layui-icon layui-icon-delete"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- è¯‘æ–‡é¢æ¿ -->
      <div class="translate-panel">
        <div class="panel-header">
          <i class="layui-icon layui-icon-fonts-code"></i>
          <span id="target-label">è¯‘æ–‡ (è‹±è¯­)</span>
        </div>
        <textarea 
          class="panel-textarea" 
          id="target-text"
          placeholder="ç¿»è¯‘ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º..."
          readonly
        ></textarea>
        <div class="panel-footer">
          <span class="char-count">
            <span id="target-count">0</span> å­—ç¬¦
          </span>
          <div class="panel-actions">
            <button class="action-btn" id="copy-btn" title="å¤åˆ¶è¯‘æ–‡">
              <i class="layui-icon layui-icon-template"></i>
            </button>
            <button class="action-btn" id="clear-target-btn" title="æ¸…ç©ºè¯‘æ–‡">
              <i class="layui-icon layui-icon-delete"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¿»è¯‘æ§åˆ¶ -->
    <div class="translate-controls">
      <button class="translate-btn" id="translate-btn">
        <i class="layui-icon layui-icon-ok"></i>
        å¼€å§‹ç¿»è¯‘
      </button>
      <button class="clear-btn translate-btn" id="clear-all-btn">
        <i class="layui-icon layui-icon-refresh-3"></i>
        æ¸…ç©ºæ‰€æœ‰
      </button>
    </div>
  </div>

  <!-- ç¿»è¯‘å†å²åŒºåŸŸ -->
  <div class="history-section">
    <h3 class="section-title">
      <i class="layui-icon layui-icon-time"></i>
      ç¿»è¯‘å†å²
    </h3>
    <div id="history-container">
      <div class="empty-state">
        <div class="empty-icon">
          <i class="layui-icon layui-icon-time"></i>
        </div>
        <p style="font-size: 16px; margin: 0;">æš‚æ— ç¿»è¯‘å†å²</p>
        <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.7;">å¼€å§‹ç¿»è¯‘åï¼Œå†å²è®°å½•å°†åœ¨æ­¤æ˜¾ç¤º</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block footer %}
<!-- åº•éƒ¨ä¿¡æ¯ -->
<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
  <p>ğŸ•·ï¸ è››ç½‘ç¿»è¯‘å¹³å° - æ‰“ç ´è¯­è¨€å£å’ï¼Œç•…é€šå…¨çƒäº¤æµ</p>
</div>
{% endblock %}

{% block js %}
<script>
layui.use(['layer'], function(){
  const layer = layui.layer;
  
  // å…¨å±€å˜é‡
  let currentRoute = 'youdao';
  let supportedLanguages = [];
  let translateHistory = [];
  let isTranslating = false;
  
  // APIé…ç½®
  const API_CONFIG = {
    youdao: {
      getLanguages: '/api/translation/m_youdao_com_get_language/',
      translate: '/api/translation/m_youdao_com_translate/'
    }
  };
  
  // DOMå…ƒç´ 
  const routeTabs = document.querySelectorAll('.route-tab');
  const currentRouteName = document.getElementById('current-route-name');
  const sourceLanguageSelect = document.getElementById('source-language');
  const targetLanguageSelect = document.getElementById('target-language');
  const swapLanguagesBtn = document.getElementById('swap-languages');
  const languageStatus = document.getElementById('language-status');
  const sourceText = document.getElementById('source-text');
  const targetText = document.getElementById('target-text');
  const sourceCount = document.getElementById('source-count');
  const targetCount = document.getElementById('target-count');
  const sourceLabel = document.getElementById('source-label');
  const targetLabel = document.getElementById('target-label');
  const translateBtn = document.getElementById('translate-btn');
  const clearAllBtn = document.getElementById('clear-all-btn');
  const pasteBtn = document.getElementById('paste-btn');
  const copyBtn = document.getElementById('copy-btn');
  const clearSourceBtn = document.getElementById('clear-source-btn');
  const clearTargetBtn = document.getElementById('clear-target-btn');
  const historyContainer = document.getElementById('history-container');
  
  // åˆå§‹åŒ–
  init();
  
  function init() {
    bindEvents();
    loadSupportedLanguages();
    loadTranslateHistory();
  }
  
  // ç»‘å®šäº‹ä»¶
  function bindEvents() {
    // çº¿è·¯åˆ‡æ¢
    routeTabs.forEach(tab => {
      tab.addEventListener('click', handleRouteChange);
    });
    
    // è¯­è¨€é€‰æ‹©
    sourceLanguageSelect.addEventListener('change', updateLanguageLabels);
    targetLanguageSelect.addEventListener('change', updateLanguageLabels);
    swapLanguagesBtn.addEventListener('click', swapLanguages);
    
    // æ–‡æœ¬è¾“å…¥
    sourceText.addEventListener('input', handleSourceTextChange);
    sourceText.addEventListener('keydown', handleKeyDown);
    
    // æŒ‰é’®äº‹ä»¶
    translateBtn.addEventListener('click', handleTranslate);
    clearAllBtn.addEventListener('click', clearAll);
    pasteBtn.addEventListener('click', pasteText);
    copyBtn.addEventListener('click', copyTranslation);
    clearSourceBtn.addEventListener('click', clearSourceText);
    clearTargetBtn.addEventListener('click', clearTargetText);
  }
  
  // å¤„ç†è·¯çº¿åˆ‡æ¢
  function handleRouteChange(e) {
    const routeData = e.target.dataset.route;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å³å°†ä¸Šçº¿çš„è·¯çº¿
    if (routeData && routeData.startsWith('coming_soon')) {
      layer.msg('è¯¥ç¿»è¯‘çº¿è·¯å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…ï¼', {icon: 6});
      return;
    }
    
    if (routeData === currentRoute) return;
    
    // æ›´æ–°æ¿€æ´»çŠ¶æ€
    routeTabs.forEach(tab => tab.classList.remove('active'));
    e.target.classList.add('active');
    
    // æ›´æ–°å½“å‰è·¯çº¿
    currentRoute = routeData;
    updateRouteDisplay();
    
    // é‡æ–°åŠ è½½æ”¯æŒçš„è¯­è¨€
    loadSupportedLanguages();
  }
  
  // æ›´æ–°è·¯çº¿æ˜¾ç¤º
  function updateRouteDisplay() {
    const routeNames = {
      youdao: 'æœ‰é“ç¿»è¯‘'
    };
    currentRouteName.textContent = routeNames[currentRoute] || 'æœªçŸ¥è·¯çº¿';
  }
  
  // åŠ è½½æ”¯æŒçš„è¯­è¨€
  async function loadSupportedLanguages() {
    try {
      languageStatus.textContent = 'æ­£åœ¨åŠ è½½æ”¯æŒçš„è¯­è¨€...';
      
      const config = API_CONFIG[currentRoute];
      if (!config) {
        throw new Error('ä¸æ”¯æŒçš„ç¿»è¯‘è·¯çº¿');
      }
      
      const response = await axios.post(config.getLanguages, {}, {
        timeout: 30000,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      });
      
      if (response.data && response.data.code === 0) {
        supportedLanguages = response.data.data || [];
        updateLanguageOptions();
        languageStatus.textContent = `å·²åŠ è½½ ${supportedLanguages.length} ç§è¯­è¨€`;
      } else {
        throw new Error(response.data?.message || 'è·å–è¯­è¨€åˆ—è¡¨å¤±è´¥');
      }
    } catch (error) {
      console.error('åŠ è½½è¯­è¨€åˆ—è¡¨å¤±è´¥:', error);
      languageStatus.textContent = 'åŠ è½½è¯­è¨€åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
      layer.msg('è·å–æ”¯æŒè¯­è¨€å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), {icon: 2});
    }
  }
  
  // æ›´æ–°è¯­è¨€é€‰é¡¹
  function updateLanguageOptions() {
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    sourceLanguageSelect.innerHTML = '';
    targetLanguageSelect.innerHTML = '';
    
    // æ·»åŠ è¯­è¨€é€‰é¡¹
    supportedLanguages.forEach(lang => {
      const sourceOption = new Option(lang.name, lang.value);
      const targetOption = new Option(lang.name, lang.value);
      
      sourceLanguageSelect.appendChild(sourceOption);
      targetLanguageSelect.appendChild(targetOption);
    });
    
    // è®¾ç½®é»˜è®¤å€¼
    if (supportedLanguages.length > 0) {
      sourceLanguageSelect.value = 'AUTO';
      // æ‰¾åˆ°è‹±è¯­é€‰é¡¹ä½œä¸ºé»˜è®¤ç›®æ ‡è¯­è¨€
      const englishOption = supportedLanguages.find(lang => 
        lang.value.includes('EN') || lang.name.includes('è‹±')
      );
      if (englishOption) {
        targetLanguageSelect.value = englishOption.value;
      }
    }
    
    updateLanguageLabels();
  }
  
  // æ›´æ–°è¯­è¨€æ ‡ç­¾
  function updateLanguageLabels() {
    const sourceOption = sourceLanguageSelect.options[sourceLanguageSelect.selectedIndex];
    const targetOption = targetLanguageSelect.options[targetLanguageSelect.selectedIndex];
    
    if (sourceOption) {
      sourceLabel.textContent = `åŸæ–‡ (${sourceOption.text})`;
    }
    if (targetOption) {
      targetLabel.textContent = `è¯‘æ–‡ (${targetOption.text})`;
    }
  }
  
  // äº¤æ¢è¯­è¨€
  function swapLanguages() {
    if (sourceLanguageSelect.value === 'AUTO') {
      layer.msg('è‡ªåŠ¨æ£€æµ‹è¯­è¨€æ— æ³•äº¤æ¢', {icon: 0});
      return;
    }
    
    const sourceValue = sourceLanguageSelect.value;
    const targetValue = targetLanguageSelect.value;
    
    sourceLanguageSelect.value = targetValue;
    targetLanguageSelect.value = sourceValue;
    
    updateLanguageLabels();
    
    // äº¤æ¢æ–‡æœ¬å†…å®¹
    const sourceTextValue = sourceText.value;
    const targetTextValue = targetText.value;
    
    sourceText.value = targetTextValue;
    targetText.value = sourceTextValue;
    
    handleSourceTextChange();
    updateTargetCount();
  }
  
  // å¤„ç†æºæ–‡æœ¬å˜åŒ–
  function handleSourceTextChange() {
    const text = sourceText.value;
    sourceCount.textContent = text.length;
  }
  
  // æ›´æ–°ç›®æ ‡æ–‡æœ¬è®¡æ•°
  function updateTargetCount() {
    targetCount.textContent = targetText.value.length;
  }
  
  // å¤„ç†é”®ç›˜äº‹ä»¶
  function handleKeyDown(e) {
    // Ctrl+Enter å¿«æ·ç¿»è¯‘
    if (e.ctrlKey && e.key === 'Enter') {
      e.preventDefault();
      handleTranslate();
    }
  }
  
  // å¤„ç†ç¿»è¯‘
  async function handleTranslate() {
    const text = sourceText.value.trim();
    
    if (!text) {
      layer.msg('è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬', {icon: 0});
      sourceText.focus();
      return;
    }
    
    if (isTranslating) {
      layer.msg('ç¿»è¯‘ä¸­ï¼Œè¯·ç¨å€™...', {icon: 16});
      return;
    }
    
    if (text.length > 5000) {
      layer.msg('æ–‡æœ¬è¿‡é•¿ï¼Œè¯·ä¿æŒåœ¨5000å­—ç¬¦ä»¥å†…', {icon: 2});
      return;
    }
    
    try {
      isTranslating = true;
      updateTranslateButton(true);
      
      const sourceLanguage = sourceLanguageSelect.value;
      const targetLanguage = targetLanguageSelect.value;
      
      // æ£€æŸ¥è¯­è¨€é€‰æ‹©
      if (sourceLanguage === targetLanguage && sourceLanguage !== 'AUTO') {
        layer.msg('æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ä¸èƒ½ç›¸åŒ', {icon: 0});
        return;
      }
      
      const config = API_CONFIG[currentRoute];
      if (!config) {
        throw new Error('ä¸æ”¯æŒçš„ç¿»è¯‘è·¯çº¿');
      }
      
      // æ„å»ºè¯·æ±‚å‚æ•°
      const requestData = {
        text: text,
        type_language: currentRoute === 'youdao' ? getYoudaoLanguageType(sourceLanguage, targetLanguage) : targetLanguage
      };
      
      const response = await axios.post(config.translate, requestData, {
        timeout: 30000,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      });
      
      if (response.data && response.data.code === 0) {
        const translatedText = response.data.data?.translate_text || '';
        targetText.value = translatedText;
        updateTargetCount();
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        addToHistory({
          source: text,
          target: translatedText,
          sourceLanguage: sourceLanguage,
          targetLanguage: targetLanguage,
          route: currentRoute,
          timestamp: new Date().getTime()
        });
        
        layer.msg('ç¿»è¯‘å®Œæˆï¼', {icon: 1});
      } else {
        throw new Error(response.data?.message || 'ç¿»è¯‘å¤±è´¥');
      }
    } catch (error) {
      console.error('ç¿»è¯‘é”™è¯¯:', error);
      layer.msg('ç¿»è¯‘å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), {icon: 2});
      
      if (error.code === 'ECONNABORTED') {
        layer.msg('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', {icon: 2});
      }
    } finally {
      isTranslating = false;
      updateTranslateButton(false);
    }
  }
  
  // è·å–æœ‰é“ç¿»è¯‘è¯­è¨€ç±»å‹
  function getYoudaoLanguageType(source, target) {
    if (source === 'AUTO') {
      return 'AUTO';
    }
    
    // æ ¹æ®æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€æ„å»ºç±»å‹
    const langMap = {
      'ZH_CN': 'ZH_CN',
      'EN': 'EN',
      'JA': 'JA',
      'KR': 'KR',
      'FR': 'FR',
      'RU': 'RU',
      'SP': 'SP'
    };
    
    const sourceCode = langMap[source] || source;
    const targetCode = langMap[target] || target;
    
    if (sourceCode && targetCode) {
      return `${sourceCode}2${targetCode}`;
    }
    
    return 'AUTO';
  }
  
  // æ›´æ–°ç¿»è¯‘æŒ‰é’®çŠ¶æ€
  function updateTranslateButton(loading) {
    if (loading) {
      translateBtn.disabled = true;
      translateBtn.innerHTML = '<div class="loading-spinner"></div> ç¿»è¯‘ä¸­...';
    } else {
      translateBtn.disabled = false;
      translateBtn.innerHTML = '<i class="layui-icon layui-icon-ok"></i> å¼€å§‹ç¿»è¯‘';
    }
  }
  
  // æ¸…ç©ºæ‰€æœ‰å†…å®¹
  function clearAll() {
    sourceText.value = '';
    targetText.value = '';
    sourceCount.textContent = '0';
    targetCount.textContent = '0';
    layer.msg('å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹', {icon: 1});
  }
  
  // ç²˜è´´æ–‡æœ¬
  async function pasteText() {
    try {
      const text = await navigator.clipboard.readText();
      if (text) {
        sourceText.value = text;
        handleSourceTextChange();
        layer.msg('å·²ç²˜è´´æ–‡æœ¬', {icon: 1});
      } else {
        layer.msg('å‰ªè´´æ¿ä¸ºç©º', {icon: 0});
      }
    } catch (error) {
      layer.msg('ç²˜è´´å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´', {icon: 2});
    }
  }
  
  // å¤åˆ¶è¯‘æ–‡
  async function copyTranslation() {
    const text = targetText.value;
    if (!text) {
      layer.msg('æ²¡æœ‰å¯å¤åˆ¶çš„è¯‘æ–‡', {icon: 0});
      return;
    }
    
    try {
      await navigator.clipboard.writeText(text);
      layer.msg('è¯‘æ–‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', {icon: 1});
    } catch (error) {
      // é™çº§å¤„ç†ï¼šé€‰ä¸­æ–‡æœ¬
      targetText.select();
      layer.msg('è¯·æ‰‹åŠ¨å¤åˆ¶é€‰ä¸­çš„æ–‡æœ¬', {icon: 0});
    }
  }
  
  // æ¸…ç©ºæºæ–‡æœ¬
  function clearSourceText() {
    sourceText.value = '';
    sourceCount.textContent = '0';
  }
  
  // æ¸…ç©ºè¯‘æ–‡
  function clearTargetText() {
    targetText.value = '';
    targetCount.textContent = '0';
  }
  
  // æ·»åŠ åˆ°å†å²è®°å½•
  function addToHistory(record) {
    translateHistory.unshift(record);
    
    // é™åˆ¶å†å²è®°å½•æ•°é‡
    if (translateHistory.length > 50) {
      translateHistory = translateHistory.slice(0, 50);
    }
    
    saveTranslateHistory();
    renderHistory();
  }
  
  // åŠ è½½ç¿»è¯‘å†å²
  function loadTranslateHistory() {
    try {
      const saved = localStorage.getItem('translate_history');
      if (saved) {
        translateHistory = JSON.parse(saved) || [];
      }
    } catch (error) {
      console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
      translateHistory = [];
    }
    renderHistory();
  }
  
  // ä¿å­˜ç¿»è¯‘å†å²
  function saveTranslateHistory() {
    try {
      localStorage.setItem('translate_history', JSON.stringify(translateHistory));
    } catch (error) {
      console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
    }
  }
  
  // æ¸²æŸ“å†å²è®°å½•
  function renderHistory() {
    if (translateHistory.length === 0) {
      historyContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <i class="layui-icon layui-icon-time"></i>
          </div>
          <p style="font-size: 16px; margin: 0;">æš‚æ— ç¿»è¯‘å†å²</p>
          <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.7;">å¼€å§‹ç¿»è¯‘åï¼Œå†å²è®°å½•å°†åœ¨æ­¤æ˜¾ç¤º</p>
        </div>
      `;
      return;
    }
    
    const historyHtml = translateHistory.map((record, index) => {
      const date = new Date(record.timestamp);
      const timeStr = date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="history-item" data-index="${index}">
          <div class="history-header">
            <span class="history-route">${getRouteDisplayName(record.route)}</span>
            <span class="history-time">${timeStr}</span>
          </div>
          <div class="history-content">
            <div class="history-text">${escapeHtml(record.source)}</div>
            <div class="history-arrow">
              <i class="layui-icon layui-icon-right"></i>
            </div>
            <div class="history-text">${escapeHtml(record.target)}</div>
          </div>
        </div>
      `;
    }).join('');
    
    historyContainer.innerHTML = `<div class="history-list" style="display: grid; gap: 12px; max-height: 400px; overflow-y: auto;">${historyHtml}</div>`;
    
    // ç»‘å®šå†å²è®°å½•ç‚¹å‡»äº‹ä»¶
    bindHistoryEvents();
  }
  
  // ç»‘å®šå†å²è®°å½•äº‹ä»¶
  function bindHistoryEvents() {
    const historyItems = document.querySelectorAll('.history-item');
    historyItems.forEach(item => {
      item.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        const record = translateHistory[index];
        if (record) {
          // æ¢å¤ç¿»è¯‘å†…å®¹
          sourceText.value = record.source;
          targetText.value = record.target;
          
          // æ›´æ–°è®¡æ•°
          handleSourceTextChange();
          updateTargetCount();
          
          layer.msg('å·²æ¢å¤å†å²ç¿»è¯‘å†…å®¹', {icon: 1});
        }
      });
    });
  }
  
  // è·å–è·¯çº¿æ˜¾ç¤ºåç§°
  function getRouteDisplayName(route) {
    const names = {
      youdao: 'æœ‰é“ç¿»è¯‘'
    };
    return names[route] || route;
  }
  
  // HTMLè½¬ä¹‰
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
});
</script>
{% endblock %}

